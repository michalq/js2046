/**
 * Game 2048 in JavaScript.
 *
 * @author Micha≈Ç Kutrzeba <kutrzeba.michal@gmail.com>
 *
 */

var G2048=function(a){var b=this,c=[],d=!1,e=4,f=4,g=16,h=new G2048.View(a,b),j=0,k=!0,l=2048;this.setHeight=function(a){f=a},this.setWidth=function(a){e=a},this.setConsole=function(a){d=a},this.setStopAt=function(a){l=a},this.getWidth=function(){return e},this.getHeight=function(){return f},this.getPoints=function(){return j},this.getView=function(){return h},this.getEmptyFields=function(){var a=[];for(i=0;g>i;i++)0==c[i]&&a.push(i);return a},this.newValue=function(){var a=b.getEmptyFields();if(0!=a.length){var c=Math.floor(Math.random()*a.length),e=2*(Math.round(Math.random())+1);b.updateField(a[c],e,!0),1==d&&(console.info("Putting new random value.",a),console.info("Random key:",c,"Random empty key:",a[c],"Random value",e))}};var m=function(){var a=b.getEmptyFields();return 0==a.length&&0==b.move(0,!0)&&0==b.move(1,!0)&&0==b.move(2,!0)&&0==b.move(3,!0)?(k=!1,!0):(k=!0,!1)};this.getGameStatus=function(){return k},this.move=function(a,g){if("undefined"==typeof g&&(g=!1),0==k)return h.onAfterMove(),1==d&&0==g&&console.info("Game end with "+j+" points."),!1;var i=null,p=null,q=0,r=0,s={},t=e*f,u=!1;addition=!1;for(var v=0;t>v;v++)if(s=n(a,v),q=s.i,r=s.end,p=o(a,q),0!=r)if(0!=c[q])if(null==i)if(c[q]==l||c[q]!=c[p]);else{if(g)return!0;j+=2*c[q],b.updateField(p,2*c[q]),b.updateField(q,0),u=!0,addition=!0,i=q}else{if(c[q]!=l&&0==addition&&c[q]==c[o(a,i)]){if(g)return!0;j+=2*c[q],b.updateField(o(a,i),2*c[q]),b.updateField(q,0),v=n(a,i).i,u=!0,addition=!0,i=null;continue}if(g)return!0;b.updateField(i,c[q]),b.updateField(q,0),v=n(a,i).i,u=!0,addition=!1,i=null}else null==i&&(i=q);else i=0==c[q]?q:null,addition=!1;return g?!1:(1==u&&b.newValue(),m(),h.onAfterMove(),void 0)};var n=function(a,b){var c;switch(a){case 0:c=b,end=c%e;break;case 1:c=b%f*e+Math.floor(b/f),end=1,e>c&&c>=0&&(end=0);break;case 2:c=g-1-b,end=(c+1)%e;break;case 3:c=Math.abs(b%f*e+Math.floor(b/f)-(g-1)),end=1,f*e>c&&c>=e*(f-1)&&(end=0)}return{i:c,end:end}},o=function(a,b){return 0==a?b-1:1==a?b-e:2==a?b+1:3==a?b+e:void 0};this.updateField=function(a,b,d){c[a]=b,h.updateField(a,b,d)},this.init=function(){g=e*f,h.init();for(var a=0;g>a;a++)c.push(0);for(var a=0;g>a;a++)b.updateField(a,c[a]);b.newValue(),b.newValue()}};G2048.View=function(a,b){"undefined"==typeof a&&(a="g2048");var d=[],e="line",f="field",g="",h="",j="";this.setRowClass=function(a){e=a},this.setFieldClass=function(a){f=a},this.setOnAfterMove=function(a){j=a},this.onAfterMove=function(){"function"==typeof j&&j(b)},this.updateField=function(a,b,c){"undefined"==typeof c&&(c=!1),htmlValue=0==b||isNaN(b)?"&nbsp;":b,$(d[a]).html(htmlValue),$(d[a]).removeClass("p0 p2 p4 p8 p16 p32 p64 p128 p256 p512 p1024 p2048"),$(d[a]).addClass("p"+b),1==c&&($(d[a]).css("opacity",0),$(d[a]).animate({opacity:1},250))};var k=function(){for(var a=$(g),c=0;c<b.getHeight();c++)a.append('<div class="'+e+'"></div>');for(var i=$(h),c=0;c<b.getWidth();c++)i.append('<div class="'+f+'"></div>');d=$(fieldselector)};this.init=function(){g="."+a,h=g+" ."+e,fieldselector=g+" ."+f,k()}};